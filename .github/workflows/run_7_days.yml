name: Run Stock Job for 3 Weeks (Mon–Fri, 11 UTC)

on:
  schedule:
    - cron: "0 11 * * 1-5"   # Runs Mon–Fri at 11:00 UTC (4:30 PM IST)
  workflow_dispatch:          # Allow manual trigger

jobs:
  run-daily:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Check if within 3-week window
        id: check-date
        shell: bash
        run: |
          start_date="2025-11-10"   # First US market open (Monday)
          end_date=$(date -d "$start_date +21 days" +%Y-%m-%d)
          today=$(date -u +"%Y-%m-%d")

          echo "Start date: $start_date"
          echo "End date:   $end_date"
          echo "Today:      $today"

          # Convert to epoch for numeric comparison
          start_epoch=$(date -d "$start_date" +%s)
          end_epoch=$(date -d "$end_date" +%s)
          today_epoch=$(date -u +%s)

          if (( today_epoch < start_epoch )); then
            echo "Not started yet. Waiting until $start_date."
            echo "continue=false" >> $GITHUB_OUTPUT
          elif (( today_epoch >= end_epoch )); then
            echo "3-week window complete. Workflow will now disable itself."
            echo "continue=false" >> $GITHUB_OUTPUT
          else
            echo "Within 3-week window. Proceeding."
            echo "continue=true" >> $GITHUB_OUTPUT
          fi

      - name: Install dependencies
        if: steps.check-date.outputs.continue == 'true'
        run: pip install -r requirements.txt

      - name: Run stock job
        if: steps.check-date.outputs.continue == 'true'
        env:
          POLYGON_API_KEY: ${{ secrets.POLYGON_API_KEY }}
          SNOWFLAKE_USER: ${{ secrets.SNOWFLAKE_USER }}
          SNOWFLAKE_PASSWORD: ${{ secrets.SNOWFLAKE_PASSWORD }}
          SNOWFLAKE_ACCOUNT: ${{ secrets.SNOWFLAKE_ACCOUNT }}
          SNOWFLAKE_WAREHOUSE: ${{ secrets.SNOWFLAKE_WAREHOUSE }}
          SNOWFLAKE_DATABASE: ${{ secrets.SNOWFLAKE_DATABASE }}
          SNOWFLAKE_SCHEMA: ${{ secrets.SNOWFLAKE_SCHEMA }}
          SNOWFLAKE_ROLE: ${{ secrets.SNOWFLAKE_ROLE }}
        run: python script.py

      - name: Disable workflow after 3 weeks
        if: steps.check-date.outputs.continue == 'false'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Disabling workflow after 3 weeks..."
          gh workflow disable "Run Stock Job for 3 Weeks (Mon–Fri, 11 UTC)"
