name: Run Stock Job at US Market Open (3 Weeks)

on:
  schedule:
    - cron: "30 14 * * 1-5"  # Runs at 2:30 PM UTC (9:30 AM ET), Mondayâ€“Friday only
  workflow_dispatch:          # Allow manual trigger from GitHub Actions tab

permissions:
  actions: write   # Required for self-disabling
  contents: read

jobs:
  run-daily:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Check if within 3-week window
        id: check-date
        run: |
          start_date="2025-11-10"   # First US market open (Monday)
          end_date=$(date -d "$start_date +21 days" +%Y-%m-%d)
          today=$(date -u +"%Y-%m-%d")

          echo "Start date: $start_date"
          echo "End date: $end_date"
          echo "Today: $today"

          if [[ "$today" < "$start_date" ]]; then
            echo "Not started yet. Waiting until $start_date."
            echo "continue=false" >> $GITHUB_OUTPUT

          elif [[ "$today" >= "$end_date" ]]; then
            echo "3-week window complete. Workflow will now disable itself."
            echo "continue=false" >> $GITHUB_OUTPUT
          else
            echo "Within 3-week window. Proceeding."
            echo "continue=true" >> $GITHUB_OUTPUT
          fi

      - name: Install dependencies
        if: steps.check-date.outputs.continue == 'true'
        run: pip install -r requirements.txt

      - name: Run stock job
        if: steps.check-date.outputs.continue == 'true'
        env:
          POLYGON_API_KEY: ${{ secrets.POLYGON_API_KEY }}
          SNOWFLAKE_USER: ${{ secrets.SNOWFLAKE_USER }}
          SNOWFLAKE_PASSWORD: ${{ secrets.SNOWFLAKE_PASSWORD }}
          SNOWFLAKE_ACCOUNT: ${{ secrets.SNOWFLAKE_ACCOUNT }}
          SNOWFLAKE_WAREHOUSE: ${{ secrets.SNOWFLAKE_WAREHOUSE }}
          SNOWFLAKE_DATABASE: ${{ secrets.SNOWFLAKE_DATABASE }}
          SNOWFLAKE_SCHEMA: ${{ secrets.SNOWFLAKE_SCHEMA }}
          SNOWFLAKE_ROLE: ${{ secrets.SNOWFLAKE_ROLE }}
        run: python script.py

      - name: Disable workflow after 3 weeks
        if: steps.check-date.outputs.continue == 'false' && always()
        run: |
          echo "Disabling workflow now..."
          curl -X PUT \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github+json" \
            https://api.github.com/repos/${{ github.repository }}/actions/workflows/run_market_open.yml/disable
